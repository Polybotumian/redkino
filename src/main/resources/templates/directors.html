<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <div th:replace="~{externals/links::link}"></div>
        <title th:text="${pageTitle}"></title>
    </head>
    <body>
        <header>
            <div th:replace="~{fragments/navbar::nav}"></div>
<!--            <img-->
<!--                    th:src="@{/icons/cam.png}"-->
<!--                    height="100"-->
<!--                    alt="Camera Logo"-->
<!--                    loading="lazy"-->
<!--            />-->
        </header>
        <main>
            <form id="searchForm" th:action="@{/directors/search}" method="post">
                <label for="searchInput">Search:</label>
                <input type="text" id="searchInput" name="query" placeholder="Enter your search term">

                <button type="submit">Search</button>
            </form>

            <!-- Check if the user is authenticated and has the 'USER' or 'ADMIN' role -->
            <div th:if="${#authorization.expression('isAuthenticated() and (hasRole(''ROLE_USER'') or hasRole(''ROLE_ADMIN''))')}">
                <button onclick="openAddDirectorDialog()" class="btn btn-block">Add New Director</button>
            </div>
            <!-- Add Director Dialog -->
            <div id="addDirectorDialog" class="modal">
                    <!-- Form to add a new movie -->
                    <form class="modal-content" id="addDirectorForm" th:action="@{/directors/add}" method="post">
                        <span class="close" onclick="closeAddDirectorDialog()">&times;</span>
                        <!-- Add a hidden input field for the movie id -->
                        <label>Director Name:</label>
                        <input type="text" th:name="name" placeholder="Director Name" required/>

                        <label>Director Surname:</label>
                        <input type="text" th:name="surname" placeholder="Director Name" required/>

                        <label>Movies:</label>
                        <select multiple="multiple" th:name="movies" th:value="*{movies}" required>
                            <!-- Iterate over actors and populate the options -->
                            <option th:each="movie : ${movies}" th:value="${movie.id}" th:text="${movie.name}"></option>
                        </select>

                        <button type="submit" class="btn btn-block">Add</button>
                    </form>
            </div>

            <!-- Movie gallery -->
            <div class="item-gallery" th:if="${directors}">
                <div th:each="director : ${directors}">
                    <div class="item-card" th:object="${director}">
                        <!-- Add movie details -->
                        <h4 th:text="*{name}"></h4>
                        <p th:text="*{surname}"></p>
                        <details>
                            <summary>Movies</summary>
                            <div th:each="movie : *{movies}">
                                <p th:object="${movie}" >
                                    <span th:text="*{name}"></span>
                                </p>
                            </div>
                        </details>

                        <div th:if="${#authorization.expression('isAuthenticated() and (hasRole(''ROLE_USER'') or hasRole(''ROLE_ADMIN''))')}">
                            <button class="btn btn-block" th:onclick="'openUpdateDirectorDialog(' + *{id} + ')'">Update</button>

                            <br>
                            <form th:action="@{/directors/delete}" method="post">
                                <input type="hidden" th:name="id" th:value="*{id}" />
                                <button class="btn btn-block" type="submit">Delete</button>
                            </form>
                        </div>

                    </div>
                    <div th:object="${director}">
                        <div th:id="'updateDirectorDialog-' + *{id}" class="modal">

                            <form class="modal-content" th:id="'updateDirectorForm-' + *{id}" th:action="@{/directors/update}" method="post">
                                <span class="close" th:onclick="'closeUpdateDirectorDialog(' + *{id} + ')'">&times;</span>
                                <!-- Add a hidden input field for the movie id -->
                                <input type="hidden" th:name="id" th:value="*{id}" />

                                <label>Director Name:</label>
                                <input type="text" th:name="name" placeholder="Movie Name" th:value="*{name}" required/>

                                <label>Director Surname:</label>
                                <input type="text" th:name="surname" placeholder="Movie Name" th:value="*{surname}" required/>

                                <label>Movies:</label>
                                <select multiple="multiple" th:name="movies" th:value="*{movies}" required>
                                    <!-- Iterate over categories and populate the options -->
                                    <option th:each="movie : ${movies}" th:value="${movie.id}" th:text="${movie.name}"
                                            th:selected="${#lists.contains(director.movies, movie)}"></option>
                                </select>

                                <button type="submit" class="btn btn-block">Update</button>
                            </form>
                        </div>
                    </div>

            </div>
            <div th:unless="${directors}">
                <p>No directors available.</p>
            </div>

            <script>
                function openAddDirectorDialog() {
                    document.getElementById('addDirectorDialog').style.display = 'block';
                }
                function closeAddDirectorDialog() {
                    document.getElementById('addDirectorDialog').style.display = 'none';
                }
                function openUpdateDirectorDialog(movieId) {
                    document.getElementById('updateDirectorDialog-' + movieId).style.display = 'block';
                }
                function closeUpdateDirectorDialog(movieId) {
                    document.getElementById('updateDirectorDialog-' + movieId).style.display = 'none';
                }
            </script>
            </div>
        </main>
        <div th:replace="~{externals/scripts}"></div>
    </body>

</html>
